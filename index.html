<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>RJ 30s Safe ‚Äî Trend Prediction Only</title>
<style>
  :root{--bg:#111;--fg:#fff;--muted:#bbb;--card:#000;
    --ylw:yellow;--grn:lime;--red:#ff4d4d;--bdr:#555;}
  *{box-sizing:border-box}
  body{background:var(--bg);color:var(--fg);font-family:Arial, sans-serif;
       margin:0;padding:18px 16px 60px}
  h2{margin:0 0 12px}
  .row{display:flex;gap:14px;flex-wrap:wrap}
  .card{background:var(--card);padding:12px 14px;border:2px solid var(--ylw);
        border-radius:12px;min-width:420px}
  #statsBox{border-color:var(--grn)}
  #controls{border-color:#888}
  #trendBox{border-color:#ff8800}
  .muted{color:var(--muted)}
  .mono{font-family:ui-monospace,Menlo,Monaco,Consolas,"Courier New",monospace}
  .highlight{color:var(--ylw);font-weight:bold}
  .win{color:var(--grn);font-weight:bold}
  .loss{color:var(--red);font-weight:bold}
  button{background:#1e1e1e;color:#fff;border:1px solid #666;
         border-radius:10px;padding:6px 10px;cursor:pointer}
  button:hover{filter:brightness(1.15)}
  button:disabled{opacity:0.6;cursor:not-allowed}
  #resultTable{margin-top:16px;width:100%;border-collapse:collapse;font-size:14px}
  #resultTable th,#resultTable td{border:1px solid var(--bdr);
               padding:6px 8px;text-align:center;vertical-align:middle}
  #resultTable thead th{position:sticky;top:0;background:#1a1a1a}
  td small{display:block;color:var(--muted);font-size:11px;margin-top:4px}
</style>
</head>
<body>
  <h2>RJ 30s Safe ‚Äî Trend Based Prediction</h2>
  <div class="row">
    <div id="predictionBox" class="card"><b>Loading...</b></div>
    <div id="trendBox" class="card"><b>Trend loading‚Ä¶</b></div>
    <div id="statsBox" class="card"><b>Loading stats...</b></div>
    <div id="controls" class="card">
      <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
        <button id="pauseBtn">Pause</button>
        <button id="resumeBtn" disabled>Resume</button>
        <button id="resetStatsBtn">Reset Stats</button>
        <button id="clearTableBtn">Clear Table</button>
        <button id="downloadExcelBtn">Download Excel</button>
        <span class="muted" id="lastSync">Last sync: ‚Äî</span>
      </div>
      <div style="margin-top:6px" class="muted" id="modeLabel">
        üîç Rule: Trend Prediction Only + Opposite Rule
      </div>
    </div>
  </div>

  <table id="resultTable" class="mono">
    <thead>
      <tr>
        <th>#</th><th>Period</th>
        <th>Prediction</th>
        <th>Actual Number</th>
        <th>Size Result</th><th>Color Result</th>
        <th>Trend Info</th>
        <th>When</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

<!-- xlsx library for export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
(function(){
  const API='https://draw.ar-lottery01.com/WinGo/WinGo_30S/GetHistoryIssuePage.json';
  const REFRESH_MS=30000, MAX_ROWS=200;
  let timer=null,lastPeriod=null,currentPrediction=null;
  let winSize=0,lossSize=0,winColor=0,lossColor=0;
  let lastTrend=null; // store last trend data used for rows

  const predictionBox=document.getElementById('predictionBox');
  const trendBox=document.getElementById('trendBox');
  const statsBox=document.getElementById('statsBox');
  const resultTableBody=document.querySelector('#resultTable tbody');
  const lastSyncEl=document.getElementById('lastSync');
  const pauseBtn=document.getElementById('pauseBtn');
  const resumeBtn=document.getElementById('resumeBtn');
  const resetStatsBtn=document.getElementById('resetStatsBtn');
  const clearTableBtn=document.getElementById('clearTableBtn');
  const downloadExcelBtn=document.getElementById('downloadExcelBtn');

  function getSize(n){return n>=5?'Big':'Small';}
  function getColor(n){return n%2===0?'Red':'Green';}

  function trendPrediction(results){
    if(results.length<10) return null;
    const last10=results.slice(0,10);
    const last5=results.slice(0,5);
    const big10=last10.filter(n=>n>=5).length;
    const big5=last5.filter(n=>n>=5).length;
    const red10=last10.filter(n=>n%2===0).length;
    const red5=last5.filter(n=>n%2===0).length;

    let sizePred= big5>=big10/2 ? "Big":"Small";
    let colorPred= red5>=red10/2 ? "Red":"Green";

    const bigPerc10=(big10/10)*100;
    const bigPerc5=(big5/5)*100;
    const redPerc10=(red10/10)*100;
    const redPerc5=(red5/5)*100;

    // OPPOSITE RULE
    if(Math.abs(bigPerc10-bigPerc5)===0 || bigPerc10-bigPerc5>=10){
      sizePred=(sizePred==="Big"?"Small":"Big");
    }
    if(Math.abs(redPerc10-redPerc5)===0 || redPerc10-redPerc5>=10){
      colorPred=(colorPred==="Red"?"Green":"Red");
    }

    return {
      nextSize:sizePred,nextColor:colorPred,
      bigPerc10,bigPerc5,redPerc10,redPerc5,
      big10,big5,red10,red5
    };
  }

  function renderTrend(pred){
    if(!pred) { trendBox.innerHTML='<b>Insufficient data</b>'; return; }
    trendBox.innerHTML=`
      <b>üìä Trend</b><br>
      Size ‚Üí 10: ${pred.bigPerc10.toFixed(1)}% ‚Ä¢ 5: ${pred.bigPerc5.toFixed(1)}% ‚Üí 
      <span class="highlight">${pred.nextSize}</span><br>
      Color ‚Üí 10: ${pred.redPerc10.toFixed(1)}% ‚Ä¢ 5: ${pred.redPerc5.toFixed(1)}% ‚Üí 
      <span class="highlight">${pred.nextColor}</span>
    `;
  }

  // Helper to build Trend Info string in the requested format:
  // Example: "70/30 = 8 result" where 70 = bigPerc10, 30 = 100 - bigPerc10,
  // and 8 = Math.round((70 - 30) / 5)
  function buildTrendInfoText(pred){
    if(!pred) return '';
    // Size info
    const sizeA = Math.round(pred.bigPerc10); // e.g., 70
    const sizeB = 100 - sizeA; // e.g., 30
    const sizeResult = Math.round((sizeA - sizeB) / 5); // e.g., 8
    const sizeText = `Size: ${sizeA}/${sizeB} = ${sizeResult} result`;

    // Color info
    const colA = Math.round(pred.redPerc10);
    const colB = 100 - colA;
    const colResult = Math.round((colA - colB) / 5);
    const colorText = `Color: ${colA}/${colB} = ${colResult} result`;

    // Also include small 5-sample percents for reference
    const extra = ` (5‚Üí ${Math.round(pred.bigPerc5)}/${Math.round(pred.redPerc5)} )`;

    return `${sizeText}<br>${colorText}${extra}`;
  }

  function addRow({period,predText,actualNum,wasSizeWin,wasColorWin}){
    const tr=document.createElement('tr');

    const trendInfoHTML = lastTrend ? buildTrendInfoText(lastTrend) : '‚Äî';

    tr.innerHTML=`<td>${resultTableBody.rows.length+1}</td>
      <td>${period}</td>
      <td>${predText}</td>
      <td>${actualNum}</td>
      <td class="${wasSizeWin?'win':'loss'}">${wasSizeWin?'Win':'Loss'}</td>
      <td class="${wasColorWin?'win':'loss'}">${wasColorWin?'Win':'Loss'}</td>
      <td style="text-align:left">${trendInfoHTML}</td>
      <td>${new Date().toLocaleTimeString()}</td>`;
    resultTableBody.insertBefore(tr,resultTableBody.firstChild);
    while(resultTableBody.rows.length>MAX_ROWS)resultTableBody.deleteRow(resultTableBody.rows.length-1);
  }

  async function fetchResults(){
    const res=await fetch(`${API}?ts=${Date.now()}`,{cache:'no-store'});
    const json=await res.json();
    const list=json?.data?.list||[];
    // make sure items present
    const results=list.slice(0,100).map(r=>parseInt(r.number,10)).filter(Number.isFinite);
    const latestPeriod=String(list[0]?.issueNumber??list[0]?.issue??'');
    return {results,latestPeriod};
  }

  async function tick(){
    try{
      const {results,latestPeriod}=await fetchResults();
      lastSyncEl.textContent='Last sync: '+new Date().toLocaleTimeString();
      if(!results.length) return;

      const trendPred=trendPrediction(results);
      if(trendPred) lastTrend = trendPred; // store for row use

      if(latestPeriod!==lastPeriod){
        // If we had a pending prediction, evaluate it against actual result (previous latest)
        if(currentPrediction){
          const actualNum = results[0];
          const actualSize = getSize(actualNum);
          const actualColor = getColor(actualNum);
          const wasSizeWin = (currentPrediction.size === actualSize);
          const wasColorWin = (currentPrediction.color === actualColor);

          if(wasSizeWin) winSize++; else lossSize++;
          if(wasColorWin) winColor++; else lossColor++;

          addRow({
            period: latestPeriod,
            predText: predictionBox.innerText,
            actualNum: actualNum,
            wasSizeWin, wasColorWin
          });
        }

        // Make new prediction for next period
        if(trendPred){
          predictionBox.innerHTML=`
            <b class="win">Trend Prediction ‚Üí 
            Size: ${trendPred.nextSize} | 
            Color: ${trendPred.nextColor}</b>`;
          currentPrediction={size:trendPred.nextSize,color:trendPred.nextColor};
          renderTrend(trendPred);
        }

        lastPeriod=latestPeriod;
      } else {
        // same period, just update trend box
        if(trendPred) renderTrend(trendPred);
      }

      statsBox.innerHTML=`<b>Size ‚Üí</b> W:${winSize} / L:${lossSize}<br>
                          <b>Color ‚Üí</b> W:${winColor} / L:${lossColor}`;
    }catch(e){
      predictionBox.innerHTML=`<b style="color:red">Error</b> (${e.message})`;
    }
  }

  function start(){ if(!timer) timer=setInterval(tick,REFRESH_MS); }
  function stop(){ if(timer){ clearInterval(timer); timer=null; } }

  pauseBtn.onclick=()=>{ stop(); pauseBtn.disabled=true; resumeBtn.disabled=false; };
  resumeBtn.onclick=()=>{ start(); resumeBtn.disabled=true; pauseBtn.disabled=false; tick(); };
  resetStatsBtn.onclick=()=>{ winSize=lossSize=winColor=lossColor=0; statsBox.innerHTML='Reset!'; };
  clearTableBtn.onclick=()=>{ resultTableBody.innerHTML=''; };

  // Excel download
  downloadExcelBtn.onclick = () => {
    try {
      const table = document.getElementById("resultTable");
      const ws = XLSX.utils.table_to_sheet(table);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Results");
      const filename = `RJ_Results_${(new Date()).toISOString().replace(/[:.]/g,'-')}.xlsx`;
      XLSX.writeFile(wb, filename);
    } catch (err) {
      alert("Export failed: " + err.message);
    }
  };

  // Kick off
  tick();
  start();
})();
</script>
</body>
</html>